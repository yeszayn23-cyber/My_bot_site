import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import Application, CommandHandler, ContextTypes, CallbackQueryHandler

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
TOKEN = '8000457608:AAEmrrhrKUf1-qRM-JDR1Ux8db3ia_v3zKw'
# Ø¶Ø¹ Ù…Ø¹Ø±Ù Ù‚Ù†Ø§ØªÙƒ Ù‡Ù†Ø§ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¨ÙˆØª Ù…Ø´Ø±ÙØ§Ù‹ ÙÙŠÙ‡Ø§)
CHANNEL_ID = '@YourChannel' 
# Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ HTML Ø§Ù„Ø°ÙŠ Ø±ÙØ¹ØªÙ‡
WEB_APP_URL = 'https://your-app-url.com' 

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

async def check_sub(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ"""
    user_id = update.effective_user.id
    try:
        member = await context.bot.get_chat_member(chat_id=CHANNEL_ID, user_id=user_id)
        return member.status in ['member', 'administrator', 'creator']
    except:
        return False

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    is_ok = await check_sub(update, context)

    if not is_ok:
        keyboard = [
            [InlineKeyboardButton("Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹ ğŸ“¢", url=f"https://t.me/{CHANNEL_ID.replace('@','')}")],
            [InlineKeyboardButton("ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ âœ…", callback_data="check")]
        ]
        await update.message.reply_text(
            f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.first_name}ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return

    # Ø²Ø± ÙØªØ­ Ø§Ù„Ù€ Web App
    kb = [[InlineKeyboardButton("ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„Ù‡ Ø£ÙˆÙ„Ø§Ù‹ âœ¨", web_app=WebAppInfo(url=WEB_APP_URL))]]
    await update.message.reply_text(
        f"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ {user.first_name} ÙÙŠ (Ø§Ù„Ù„Ù‡ Ø£ÙˆÙ„Ø§Ù‹).",
        reply_markup=InlineKeyboardMarkup(kb)
    )

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    if query.data == "check":
        is_ok = await check_sub(update, context)
        if is_ok:
            await query.edit_message_text("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚! Ø£Ø±Ø³Ù„ /start Ø§Ù„Ø¢Ù†.")
        else:
            await query.answer("Ù„Ù… ØªØ´ØªØ±Ùƒ Ø¨Ø¹Ø¯!", show_alert=True)

if __name__ == '__main__':
    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_callback))
    print("Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„...")
    app.run_polling()
