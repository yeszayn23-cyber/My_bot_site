import telebot
from telebot import types

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ---
API_TOKEN = '8000457608:AAEmrrhrKUf1-qRM-JDR1Ux8db3ia_v3zKw'
ADMIN_ID = 8421694319 
CHANNEL_ID = '@fi9ha'
bot = telebot.TeleBot(API_TOKEN)

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
config = {
    "site_url": "https://www.google.com", # ØºÙŠØ±Ù‡ Ø¨Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹Ùƒ Ù„Ø§Ø­Ù‚Ø§Ù‹
    "welcome_msg": "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø¨Ù†Ø¬Ø§Ø­. âœ…",
    "sub_required_msg": "ÙŠØ§ Ø®ÙˆÙŠØ§ Ø§Ù„Ø¹Ø²ÙŠØ²ØŒ Ù„Ø§Ø²Ù… ØªØ´ØªØ±Ùƒ ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙˆØª Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ø´ ØªÙ‚Ø¯Ø± ØªØ¯Ø®Ù„ Ù„Ù„Ù…ÙˆÙ‚Ø¹! ğŸ‘‡"
}

# --- Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ---
def is_subscribed(user_id):
    try:
        status = bot.get_chat_member(CHANNEL_ID, user_id).status
        if status in ['member', 'administrator', 'creator']:
            return True
        return False
    except Exception as e:
        print(f"Error checking sub: {e}")
        return False

# --- Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /start ---
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    
    # 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ„Ø§Ù‹
    if is_subscribed(user_id):
        # Ø¥Ø°Ø§ Ù…Ø´ØªØ±Ùƒ: Ù†Ø¨Ø¹Ø«ÙˆÙ„Ùˆ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ²Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹
        markup = types.InlineKeyboardMarkup()
        web_btn = types.InlineKeyboardButton("Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù† ğŸŒ", url=config["site_url"])
        markup.add(web_btn)
        
        bot.send_message(user_id, f"{config['welcome_msg']}\n\nØªÙØ¶Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ø¯Ù†Ø§Ù‡:", reply_markup=markup)
    else:
        # Ø¥Ø°Ø§ Ù…Ø´ Ù…Ø´ØªØ±Ùƒ: Ù†Ø·Ù„Ø¹ÙˆÙ„Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø© ÙˆØ²Ø± Ø§Ù„ØªØ­Ù‚Ù‚
        markup = types.InlineKeyboardMarkup()
        join_btn = types.InlineKeyboardButton("Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ù…Ù† Ù‡Ù†Ø§ ğŸ“¢", url=f"https://t.me/{CHANNEL_ID[1:]}")
        verify_btn = types.InlineKeyboardButton("ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø¯Ø®ÙˆÙ„ âœ…", callback_data="check_sub")
        markup.add(join_btn)
        markup.add(verify_btn)
        
        bot.send_message(user_id, config["sub_required_msg"], reply_markup=markup)

# --- Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± "ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" ---
@bot.callback_query_handler(func=lambda call: call.data == "check_sub")
def verify_callback(call):
    if is_subscribed(call.from_user.id):
        bot.answer_callback_query(call.id, "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚! ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„. ğŸ‰")
        # Ù†Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆÙ†Ø¨Ø¹Ø« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
        bot.delete_message(call.message.chat.id, call.message.message_id)
        start(call.message) 
    else:
        bot.answer_callback_query(call.id, "Ù„Ù… ØªØ´ØªØ±Ùƒ Ø¨Ø¹Ø¯! âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹.", show_alert=True)

# --- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† (Ø£Ù†Øª ÙÙ‚Ø·) ---
@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if message.from_user.id == ADMIN_ID:
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("ØªØ¹Ø¯ÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ ğŸ”—", callback_data="edit_url"))
        
        msg = f"ğŸ›  **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†**\n\nØ§Ù„Ù‚Ù†Ø§Ø©: {CHANNEL_ID}\nØ§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: {config['site_url']}"
        bot.send_message(ADMIN_ID, msg, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "edit_url")
def edit_url_step(call):
    msg = bot.send_message(ADMIN_ID, "Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: https://example.com):")
    bot.register_next_step_handler(msg, save_new_url)

def save_new_url(message):
    config["site_url"] = message.text
    bot.send_message(ADMIN_ID, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
print("Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„ Ø§Ù„Ø¢Ù†...")
bot.polling(none_stop=True)

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù„Ù‡ Ø£ÙˆÙ„Ø§Ù‹</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Reem+Kufi:wght@700&display=swap');
        
        :root {
            --gold-gradient: linear-gradient(145deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --dark-gold: #8b6b23;
            --creamy: #fdfaf1;
            --brown: #4a342e;
            --bg-color: var(--creamy);
            --text-color: var(--brown);
            --card-bg: #ffffff;
            --btn-shadow: 4px 4px 10px #d1cfc7, -4px -4px 10px #ffffff;
            --pattern: url('https://www.transparenttextures.com/patterns/arabesque.png');
        }

        body { 
            font-family: 'Amiri', serif; 
            background-color: var(--bg-color); 
            background-image: var(--pattern);
            background-size: auto;
            background-attachment: fixed;
            color: var(--text-color); 
            margin: 0; padding: 15px; 
            transition: all 0.4s ease; 
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .dark-mode { 
            --bg-color: #2b1d0e; --text-color: #fcf9f2; --card-bg: #3d2b1a;
            --btn-shadow: 5px 5px 12px #1a1209, -2px -2px 8px #4d3621;
        }
        
        .ramadan-mode { 
            --bg-color: #050a18; --text-color: #e0e0e0; --card-bg: #0d1b3e; --dark-gold: #ffd700;
            background-image: radial-gradient(circle at top, #1a2a4e, #050a18), url('https://www.transparenttextures.com/patterns/black-paper.png');
            --btn-shadow: 5px 5px 15px #02050d;
        }

        .container { max-width: 500px; margin: auto; }

        .logo { 
            font-family: 'Reem Kufi', sans-serif; font-size: 3.8em; 
            background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin: 0; filter: drop-shadow(2px 3px 4px rgba(0,0,0,0.2));
            text-align: center;
        }

        .main-btn-3d {
            background: var(--card-bg); border: 2px solid var(--dark-gold);
            padding: 16px; border-radius: 18px; margin-bottom: 12px;
            color: var(--text-color); font-weight: bold; width: 100%;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--btn-shadow); transition: 0.2s; border-box: box-sizing;
        }
        .main-btn-3d:active { transform: scale(0.97); }

        .global-tasbih-circle {
            width: 170px; height: 170px; margin: 25px auto;
            border-radius: 50%; background: var(--card-bg);
            border: 6px double var(--dark-gold); display: flex; flex-direction: column;
            justify-content: center; align-items: center; box-shadow: var(--btn-shadow);
            cursor: pointer; position: relative;
        }

        .section { display: none; animation: fadeIn 0.5s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #adminPanel { background: rgba(184, 134, 11, 0.12); border: 2px dashed var(--dark-gold); padding: 15px; border-radius: 20px; margin-top: 30px; text-align: right; }
        .admin-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--dark-gold); background: var(--card-bg); color: var(--text-color); font-family: 'Amiri'; box-sizing: border-box; }

        .card { background: var(--card-bg); padding: 18px; border-radius: 18px; box-shadow: var(--btn-shadow); border-right: 6px solid var(--dark-gold); margin-bottom: 15px; text-align: right; line-height: 1.7; }
        
        .theme-nav { position: fixed; bottom: 20px; left: 20px; display: flex; gap: 10px; z-index: 1000; }
        .theme-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="khalwaOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:10000; flex-direction:column; justify-content:center; align-items:center; color:#fff; text-align:center;">
    <div id="khalwaAyah" style="font-size: 1.8em; padding: 30px; line-height: 1.6;"></div>
    <button class="main-btn-3d" style="width:auto; background:none; color:white; border-color:white;" onclick="closeKhalwa()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø®Ù„ÙˆØ©</button>
</div>

<div class="theme-nav">
    <button class="theme-btn" style="background: #fdfaf1;" onclick="toggleMode('light')"></button>
    <button class="theme-btn" style="background: #2b1d0e;" onclick="toggleMode('dark')"></button>
    <button class="theme-btn" style="background: #050a18;" onclick="toggleMode('ramadan')"></button>
</div>

<div class="container">
    <div id="home" class="section active">
        <h1 class="logo">Ø§Ù„Ù„Ù‡ Ø£ÙˆÙ„Ø§Ù‹</h1>
        <p style="text-align:center; font-style:italic; color:var(--dark-gold); margin-top:-10px;">Ø³ÙŠØ±ÙˆØ§ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ø±Ø¬Ù‰ ÙˆÙ…ÙƒØ§Ø³ÙŠØ±</p>

        <div class="global-tasbih-circle" onclick="incrementGlobal()">
            <span style="font-size: 0.8em; color: var(--dark-gold);">Ø§Ù„Ø³Ø¨Ø­Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</span>
            <div id="globalCount" style="font-size: 2.5em; font-family:'Reem Kufi'; color: var(--dark-gold);">0</div>
            <button id="resetBtn" style="display:none; position:absolute; bottom:5px; background:none; border:none; cursor:pointer;" onclick="resetGlobal(event)">ğŸ”„</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="main-btn-3d" onclick="showSection('namesList')">Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ğŸ“–</button>
            <button class="main-btn-3d" onclick="startKhalwa()">Ø§Ù„Ø®Ù„ÙˆØ© ğŸ§˜â€â™‚ï¸</button>
            <button class="main-btn-3d" onclick="showSection('munajatPage')">Ø§Ù„Ù…Ù†Ø§Ø¬Ø§Ø© ğŸ¤²</button>
            <button class="main-btn-3d" onclick="showSection('thoughtsSection')">Ø®ÙˆØ§Ø·Ø± âœ¨</button>
            <button class="main-btn-3d" style="grid-column: span 2;" onclick="showSection('moodPage')">ÙƒÙŠÙ Ø­Ø§Ù„ Ù‚Ù„Ø¨ÙƒØŸ â¤ï¸</button>
            <button class="main-btn-3d" style="grid-column: span 2; background:var(--gold-gradient); color:#000; border:none;" onclick="showSection('favoritesPage')">Ø®Ø²Ø§Ù†Ø© Ø±Ø³Ø§Ø¦Ù„ÙŠ</button>
        </div>

        <div id="adminPanel" style="display:none;">
            <h3 style="color:var(--dark-gold); margin:0 0 10px 0;">ğŸ›  Ø§Ù„ØªØ­ÙƒÙ… (Ù„Ù„Ù…Ø§Ù„ÙƒØ© ÙÙ‚Ø·)</h3>
            <select id="adminActionType" class="admin-input">
                <option value="names">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… ÙˆÙ…Ù‚Ø§Ù„Ù‡</option>
                <option value="tasks">Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø¹Ù…Ù„ Ù„Ø§Ø³Ù…</option>
                <option value="thoughts">Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ø·Ø±Ø©</option>
                <option value="moods">Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ù‚Ù„Ø¨ (Ù…ÙƒØ³ÙˆØ±ØŒ Ø³Ø¹ÙŠØ¯..)</option>
                <option value="khalwa">Ø¥Ø¶Ø§ÙØ© Ø¹Ø¨Ø§Ø±Ø© Ù„Ù„Ø®Ù„ÙˆØ©</option>
            </select>
            <input type="text" id="targetName" class="admin-input" placeholder="Ø§Ù„Ø§Ø³Ù… / Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©">
            <textarea id="mainContent" class="admin-input" rows="3" placeholder="Ø§Ù„Ù…Ø­ØªÙˆÙ‰..."></textarea>
            <button class="main-btn-3d" style="background:var(--dark-gold); color:#fff; justify-content:center;" onclick="saveToFirebase()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
            
            <div style="border-top: 2px solid var(--dark-gold); margin-top:15px; padding-top:10px;">
                <p style="font-size:0.9em; color:var(--dark-gold); font-weight:bold;">ğŸ–¼ ØªØºÙŠÙŠØ± Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„ÙƒÙ„:</p>
                <input type="file" id="bgUploader" accept="image/*" style="display:none" onchange="uploadBackground(this)">
                <button class="main-btn-3d" style="background:#f0f0f0; color:#333; justify-content:center; font-size:0.9em;" onclick="document.getElementById('bgUploader').click()">ğŸ“¸ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù…Ù† Ù‡Ø§ØªÙÙƒ</button>
                <button class="main-btn-3d" style="background:#ff4d4d; color:#fff; justify-content:center; font-size:0.9em;" onclick="deleteBackground()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØµØµØ©</button>
            </div>
        </div>
    </div>

    <div id="namesList" class="section">
        <h2 class="logo" style="font-size: 2.5em;">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø³Ù†Ù‰</h2>
        <div id="namesGrid"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="nameDetailsPage" class="section">
        <h2 id="detTitle" class="logo"></h2>
        <div class="card" id="detContent"></div>
        <h3 style="color:var(--dark-gold)">ğŸ“ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…:</h3>
        <div id="detTasks"></div>
        <div class="global-tasbih-circle" onclick="incrementLocal()">
            <span style="font-size: 0.7em;">ÙˆØ±Ø¯ Ø§Ù„Ø§Ø³Ù…</span>
            <div id="localCount" style="font-size: 2.2em; color:var(--dark-gold);">0</div>
        </div>
        <h3 style="color:var(--dark-gold)">ğŸ’¬ Ù…ÙˆØ§Ù‚Ù Ø§Ù„Ù†ÙˆØ± (Ù…Ø´Ø§Ø±ÙƒØ§ØªÙƒÙ…):</h3>
        <div id="detStories"></div>
        <textarea id="userStoryText" class="admin-input" placeholder="Ø´Ø§Ø±ÙƒÙ†Ø§ Ù…ÙˆÙ‚ÙØ§Ù‹ Ø­Ø¯Ø« Ù„Ùƒ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…..."></textarea>
        <button class="main-btn-3d" style="background:var(--gold-gradient); color:#000; border:none; justify-content:center;" onclick="submitUserStory()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ù Ù„Ù„Ø¬Ù…ÙŠØ¹ âœ¨</button>
        <button class="main-btn-3d" style="justify-content:center; margin-top:20px;" onclick="showSection('namesList')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    </div>

    <div id="thoughtsSection" class="section">
        <h2 class="logo" style="font-size: 2.5em;">Ø®ÙˆØ§Ø·Ø±</h2>
        <div id="thoughtsList"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="moodPage" class="section">
        <h2 class="logo" style="font-size: 2.5em;">Ø­Ø§Ù„ Ù‚Ù„Ø¨Ùƒ</h2>
        <div id="moodGrid"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="favoritesPage" class="section">
        <h2 class="logo" style="font-size: 2.5em;">Ø®Ø²Ø§Ù†ØªÙŠ</h2>
        <div id="favList"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="munajatPage" class="section">
        <h2 class="logo" style="font-size: 2.5em;">Ù…Ù†Ø§Ø¬Ø§Ø©</h2>
        <div class="card">
            <textarea id="munajatInput" class="admin-input" style="height:150px" placeholder="ØªØ­Ø¯Ø« Ù…Ø¹ Ø®Ø§Ù„Ù‚Ùƒ.. Ø§Ù„ÙƒÙ„Ù…Ø§Øª ØªØ±ÙØ¹ Ù„Ù„Ø³Ù…Ø§Ø¡ ÙÙˆØ±Ø§Ù‹"></textarea>
            <button class="main-btn-3d" style="background:var(--gold-gradient); color:#000; border:none; justify-content:center;" onclick="sendMunajat()">Ø£Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù„Ù‡ Ù‚Ù„Ø¨ÙŠ</button>
        </div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const ADMIN_ID = 8421694319;
    const firebaseConfig = { databaseURL: "https://allahfirst-b9c52-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentActiveName = "";
    let myFavs = JSON.parse(localStorage.getItem('allah_first_favs') || '[]');

    // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø®Ù„ÙÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© ---
    db.ref('app_settings/custom_bg').on('value', s => {
        const bgData = s.val();
        if (bgData) {
            document.body.style.backgroundImage = `url(${bgData})`;
            document.body.style.backgroundSize = "cover";
            document.body.style.backgroundPosition = "center";
        } else {
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù†Ù…Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø±ÙÙˆØ¹Ø©
            document.body.style.backgroundImage = "var(--pattern)";
            document.body.style.backgroundSize = "auto";
        }
    });

    function uploadBackground(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                db.ref('app_settings/custom_bg').set(base64Image)
                    .then(() => alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…ÙŠØ¹! âœ¨"))
                    .catch(err => alert("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ Ø­Ø§ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ØµØºØ±."));
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function deleteBackground() {
        if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£ØµÙ„ØŸ')) {
            db.ref('app_settings/custom_bg').remove();
        }
    }

    function toggleMode(m) {
        document.body.classList.remove('dark-mode', 'ramadan-mode');
        if(m === 'dark') document.body.classList.add('dark-mode');
        if(m === 'ramadan') document.body.classList.add('ramadan-mode');
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'namesList') loadNames();
        if(id === 'thoughtsSection') loadThoughts();
        if(id === 'moodPage') loadMoods();
        if(id === 'favoritesPage') renderFavorites();
        window.scrollTo(0,0);
    }

    function incrementGlobal() { db.ref('global_count').transaction(c => (c || 0) + 1); }
    db.ref('global_count').on('value', s => { document.getElementById('globalCount').innerText = (s.val() || 0).toLocaleString(); });
    function resetGlobal(e) { e.stopPropagation(); if(confirm('ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ØŸ')) db.ref('global_count').set(0); }
    
    let lCnt = 0;
    function incrementLocal() { lCnt++; document.getElementById('localCount').innerText = lCnt; }

    function loadNames() {
        db.ref('names').on('value', s => {
            const grid = document.getElementById('namesGrid'); grid.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).forEach(n => {
                const btn = document.createElement('div'); btn.className = "main-btn-3d";
                btn.innerHTML = `<span style="flex:1" onclick="openNamePage('${n}')">${n}</span>`;
                if(tg.initDataUnsafe.user?.id === ADMIN_ID) btn.innerHTML += `<span onclick="deleteItem('names/${n}')">ğŸ—‘ï¸</span>`;
                grid.appendChild(btn);
            });
        });
    }

    function openNamePage(n) {
        currentActiveName = n; lCnt = 0; document.getElementById('localCount').innerText = 0;
        db.ref('names/' + n).once('value', s => {
            document.getElementById('detTitle').innerText = n;
            document.getElementById('detContent').innerText = s.val() || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ø­Ø§Ù„ÙŠØ§Ù‹.";
            loadList('tasks/' + n, 'detTasks', false);
            loadList('stories/' + n, 'detStories', true);
            showSection('nameDetailsPage');
        });
    }

    function loadList(path, containerId, isStories) {
        db.ref(path).on('value', s => {
            const container = document.getElementById(containerId); container.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).forEach(k => {
                const div = document.createElement('div'); div.className = "card";
                div.innerHTML = `<p>${isStories ? data[k] : 'â€¢ ' + data[k]}</p>`;
                if(tg.initDataUnsafe.user?.id === ADMIN_ID) div.innerHTML += `<span style="cursor:pointer" onclick="deleteItem('${path}/${k}')">ğŸ—‘ï¸ Ø­Ø°Ù</span>`;
                container.appendChild(div);
            });
        });
    }

    function loadMoods() {
        db.ref('moods').on('value', s => {
            const grid = document.getElementById('moodGrid'); grid.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).forEach(m => {
                const btn = document.createElement('div'); btn.className = "main-btn-3d";
                btn.innerHTML = `<span style="flex:1" onclick="alert('${data[m]}')">${m}</span>`;
                if(tg.initDataUnsafe.user?.id === ADMIN_ID) btn.innerHTML += `<span onclick="deleteItem('moods/${m}')">ğŸ—‘ï¸</span>`;
                grid.appendChild(btn);
            });
        });
    }

    function startKhalwa() {
        db.ref('khalwa').once('value', s => {
            const data = s.val() || ["ØªÙ‡ÙŠØ£ Ù„Ù„Ù‚Ø§Ø¡ Ø§Ù„Ù„Ù‡ Ø¨Ù‚Ù„Ø¨ Ø­Ø§Ø¶Ø±.."];
            const phrases = Object.values(data);
            const overlay = document.getElementById('khalwaOverlay');
            const textElem = document.getElementById('khalwaAyah');
            overlay.style.display = 'flex';
            let i = 0;
            textElem.innerText = phrases[0];
            window.kTimer = setInterval(() => {
                textElem.style.opacity = 0;
                setTimeout(() => {
                    i = (i + 1) % phrases.length;
                    textElem.innerText = phrases[i];
                    textElem.style.opacity = 1;
                }, 1000);
            }, 6000);
        });
    }
    function closeKhalwa() { clearInterval(window.kTimer); document.getElementById('khalwaOverlay').style.display = 'none'; }

    function saveToFirebase() {
        const type = document.getElementById('adminActionType').value;
        const target = document.getElementById('targetName').value;
        const content = document.getElementById('mainContent').value;
        if(!content) return;

        if(type === 'thoughts' || type === 'khalwa') {
            db.ref(type).push(content);
        } else if(type === 'tasks') {
            if(!target) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ù‡ ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰!");
            db.ref('tasks/' + target).push(content);
        } else {
            if(!target) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©!");
            db.ref(type + '/' + target).set(content);
        }
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ“");
        document.getElementById('mainContent').value = "";
    }

    function deleteItem(path) { if(confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) db.ref(path).remove(); }

    function submitUserStory() {
        const text = document.getElementById('userStoryText').value;
        if(!text) return;
        db.ref('stories/' + currentActiveName).push(text);
        document.getElementById('userStoryText').value = "";
    }

    function toggleFavorite(text) {
        const index = myFavs.indexOf(text);
        if(index > -1) myFavs.splice(index, 1);
        else myFavs.push(text);
        localStorage.setItem('allah_first_favs', JSON.stringify(myFavs));
        alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø®Ø²Ø§Ù†ØªÙŠ â¤ï¸");
    }

    function renderFavorites() {
        const list = document.getElementById('favList'); list.innerHTML = "";
        myFavs.forEach(text => {
            const div = document.createElement('div'); div.className = "card";
            div.innerHTML = `<p>${text}</p>`;
            list.appendChild(div);
        });
    }

    function loadThoughts() {
        db.ref('thoughts').on('value', s => {
            const list = document.getElementById('thoughtsList'); list.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).reverse().forEach(k => {
                const text = data[k];
                const card = document.createElement('div'); card.className = "card";
                card.innerHTML = `<p>${text}</p>
                    <button onclick="toggleFavorite(\`${text.replace(/'/g, "")}\`)" style="border:none; background:none; color:red; cursor:pointer;">â¤ï¸ Ø­ÙØ¸</button>`;
                if(tg.initDataUnsafe.user?.id === ADMIN_ID) card.innerHTML += `<span onclick="deleteItem('thoughts/${k}')"> ğŸ—‘ï¸</span>`;
                list.appendChild(card);
            });
        });
    }

    function sendMunajat() {
        alert("Ø§Ù„Ù„Ù‡ ÙŠØ³Ù…Ø¹Ùƒ.. Ø·ÙØ¨ Ù†ÙØ³Ø§Ù‹ âœ¨");
        document.getElementById('munajatInput').value = "";
        showSection('home');
    }

    if(tg.initDataUnsafe.user?.id === ADMIN_ID) {
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('resetBtn').style.display = 'block';
    }
    tg.expand();
</script>
</body>
</html>
