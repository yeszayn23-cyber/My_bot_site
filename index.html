<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù„Ù‡ Ø£ÙˆÙ„Ø§Ù‹</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Reem+Kufi:wght@700&display=swap');
        
        :root {
            --gold-gradient: linear-gradient(145deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --dark-gold: #8b6b23;
            --creamy: #fdfaf1;
            --brown: #4a342e;
            --bg-color: var(--creamy);
            --text-color: var(--brown);
            --card-bg: #ffffff;
            --btn-shadow: 4px 4px 10px #d1cfc7, -4px -4px 10px #ffffff;
            --pattern: url('https://www.transparenttextures.com/patterns/arabesque.png');
        }

        body { 
            font-family: 'Amiri', serif; background-color: var(--bg-color); 
            background-image: var(--pattern); background-attachment: fixed;
            color: var(--text-color); margin: 0; padding: 15px; min-height: 100vh;
        }

        .dark-mode { --bg-color: #2b1d0e; --text-color: #fcf9f2; --card-bg: #3d2b1a; }
        .ramadan-mode { --bg-color: #050a18; --text-color: #e0e0e0; --card-bg: #0d1b3e; --dark-gold: #ffd700; }

        .container { max-width: 500px; margin: auto; }
        .logo { font-family: 'Reem Kufi', sans-serif; font-size: 3.5em; background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; margin: 10px 0; }

        .main-btn-3d {
            background: var(--card-bg); border: 2px solid var(--dark-gold);
            padding: 16px; border-radius: 18px; margin-bottom: 12px;
            color: var(--text-color); font-weight: bold; width: 100%;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--btn-shadow); box-sizing: border-box;
        }

        .section { display: none; }
        .active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card-bg); padding: 18px; border-radius: 18px; box-shadow: var(--btn-shadow); border-right: 6px solid var(--dark-gold); margin-bottom: 15px; text-align: right; }
        .admin-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--dark-gold); background: var(--card-bg); color: var(--text-color); font-family: 'Amiri'; box-sizing: border-box; }

        #subGuard {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 99999; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center;
        }
        .global-tasbih-circle { width: 160px; height: 160px; margin: 20px auto; border-radius: 50%; border: 5px double var(--dark-gold); display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
    </style>
</head>
<body>

<div id="subGuard">
    <h1 class="logo" style="font-size: 2em;">Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù‚Ù†Ø§Ø©</h1>
    <p>Ù„Ù„Ø§Ø³ØªÙ…ØªØ§Ø¹ Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹.</p>
    <a href="https://t.me/fi9ha" target="_blank" class="main-btn-3d" style="text-decoration:none; justify-content:center; background:var(--gold-gradient); color:#000;">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</a>
    <button class="main-btn-3d" style="justify-content:center; margin-top:10px;" onclick="verifySubscription()">Ø¯Ø®ÙˆÙ„ âœ¨</button>
</div>

<div class="container" id="mainAppContent">
    <div id="home" class="section active">
        <h1 class="logo">Ø§Ù„Ù„Ù‡ Ø£ÙˆÙ„Ø§Ù‹</h1>
        <div class="global-tasbih-circle" onclick="incrementGlobal()">
            <span style="font-size: 0.8em;">Ø³Ø¨Ø­Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</span>
            <div id="globalCount" style="font-size: 2em; color: var(--dark-gold);">0</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="main-btn-3d" onclick="showSection('namesList')">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø³Ù†Ù‰</button>
            <button class="main-btn-3d" onclick="showSection('thoughtsSection')">Ø®ÙˆØ§Ø·Ø±</button>
            <button class="main-btn-3d" onclick="showSection('moodPage')">Ø­Ø§Ù„ Ù‚Ù„Ø¨Ùƒ</button>
            <button class="main-btn-3d" onclick="showSection('favoritesPage')">Ø®Ø²Ø§Ù†ØªÙŠ â¤ï¸</button>
        </div>

        <div id="adminPanel" style="display:none; margin-top:20px; border:1px dashed var(--dark-gold); padding:10px; border-radius:15px;">
            <h3 style="text-align:center">ğŸ›  Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <select id="adminActionType" class="admin-input">
                <option value="thoughts">Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ø·Ø±Ø©</option>
                <option value="moods">Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ù‚Ù„Ø¨</option>
                <option value="names">Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù…</option>
            </select>
            <input type="text" id="targetName" class="admin-input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…">
            <textarea id="mainContent" class="admin-input" rows="3" placeholder="Ø§Ù„Ù…Ø­ØªÙˆÙ‰"></textarea>
            <button class="main-btn-3d" style="justify-content:center; background:var(--dark-gold); color:#fff;" onclick="saveToFirebase()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
        </div>
    </div>

    <div id="namesList" class="section">
        <h2 class="logo" style="font-size: 2em;">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø³Ù†Ù‰</h2>
        <div id="namesGrid"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="thoughtsSection" class="section">
        <h2 class="logo" style="font-size: 2em;">Ø®ÙˆØ§Ø·Ø± Ø¥ÙŠÙ…Ø§Ù†ÙŠØ©</h2>
        <div id="thoughtsList"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="moodPage" class="section">
        <h2 class="logo" style="font-size: 2em;">ÙƒÙŠÙ Ø­Ø§Ù„ Ù‚Ù„Ø¨ÙƒØŸ</h2>
        <div id="moodGrid"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="favoritesPage" class="section">
        <h2 class="logo" style="font-size: 2em;">Ø®Ø²Ø§Ù†ØªÙŠ</h2>
        <div id="favList"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const ADMIN_ID = 8421694319;
    const firebaseConfig = { databaseURL: "https://allahfirst-b9c52-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const BOT_TOKEN = '8000457608:AAEmrrhrKUf1-qRM-JDR1Ux8db3ia_v3zKw'; 
    const CHANNEL_ID = '@fi9ha'; 

    // --- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ---
    async function verifySubscription() {
        const uId = tg.initDataUnsafe.user?.id;
        if (uId === ADMIN_ID) { 
            document.getElementById('subGuard').style.display = 'none';
            return;
        }
        try {
            const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getChatMember?chat_id=${CHANNEL_ID}&user_id=${uId}`);
            const data = await res.json();
            if (data.ok && ['member', 'administrator', 'creator'].includes(data.result.status)) {
                document.getElementById('subGuard').style.display = 'none';
            } else {
                document.getElementById('subGuard').style.display = 'flex';
                alert("Ø§Ù†Ø¶Ù… Ù„Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹ â¤ï¸");
            }
        } catch(e) { document.getElementById('subGuard').style.display = 'none'; }
    }
    verifySubscription();

    // --- Ø§Ù„ØªÙ†Ù‚Ù„ ---
    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'thoughtsSection') loadThoughts();
        if(id === 'moodPage') loadMoods();
        if(id === 'namesList') loadNames();
        if(id === 'favoritesPage') renderFavorites();
    }

    // --- Ø§Ù„Ø³Ø¨Ø­Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© ---
    function incrementGlobal() { db.ref('global_count').transaction(c => (c || 0) + 1); }
    db.ref('global_count').on('value', s => { document.getElementById('globalCount').innerText = s.val() || 0; });

    // --- Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø°Ø±ÙŠ) ---
    function saveToFirebase() {
        const type = document.getElementById('adminActionType').value;
        const target = document.getElementById('targetName').value.trim();
        const content = document.getElementById('mainContent').value.trim();
        if(!content) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰!");

        if(type === 'thoughts') {
            db.ref('thoughts').push(content).then(() => alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø§Ø·Ø±Ø© âœ“"));
        } else if(type === 'moods') {
            if(!target) return alert("Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø­Ø²ÙŠÙ†)");
            db.ref('moods/' + target).set(content).then(() => alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© âœ“"));
        } else if(type === 'names') {
            if(!target) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…");
            db.ref('names/' + target).set(content).then(() => alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… âœ“"));
        }
        document.getElementById('mainContent').value = "";
    }

    // --- Ø§Ù„Ø­Ø°Ù ---
    function deleteItem(path) {
        if(confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) db.ref(path).remove().then(() => alert("ØªÙ… Ø§Ù„Ø­Ø°Ù"));
    }

    // --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ÙˆØ§Ø·Ø± ---
    function loadThoughts() {
        db.ref('thoughts').on('value', s => {
            const list = document.getElementById('thoughtsList'); list.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).reverse().forEach(k => {
                const text = data[k];
                const card = document.createElement('div'); card.className = "card";
                card.innerHTML = `<p>${text}</p>
                    <button onclick="toggleFavorite('${text.replace(/'/g, "\\'")}')" style="color:red; border:none; background:none; cursor:pointer">â¤ï¸ Ø­ÙØ¸</button>`;
                if(tg.initDataUnsafe.user?.id === ADMIN_ID) {
                    card.innerHTML += `<button onclick="deleteItem('thoughts/${k}')" style="margin-right:10px">ğŸ—‘ï¸ Ø­Ø°Ù</button>`;
                }
                list.appendChild(card);
            });
        });
    }

    // --- ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù‚Ù„Ø¨ ---
    function loadMoods() {
        db.ref('moods').on('value', s => {
            const grid = document.getElementById('moodGrid'); grid.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).forEach(m => {
                const btn = document.createElement('div'); btn.className = "main-btn-3d";
                btn.innerHTML = `<span style="flex:1" onclick="alert(\`${data[m].replace(/`/g, "'")}\`)">${m}</span>`;
                if(tg.initDataUnsafe.user?.id === ADMIN_ID) {
                    btn.innerHTML += `<span onclick="deleteItem('moods/${m}')">ğŸ—‘ï¸</span>`;
                }
                grid.appendChild(btn);
            });
        });
    }

    // --- Ø§Ù„Ø®Ø²Ø§Ù†Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ---
    let myFavs = JSON.parse(localStorage.getItem('my_favs') || '[]');
    function toggleFavorite(text) {
        if(!myFavs.includes(text)) {
            myFavs.push(text);
            localStorage.setItem('my_favs', JSON.stringify(myFavs));
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø®Ø²Ø§Ù†ØªÙƒ â¤ï¸");
        }
    }
    function renderFavorites() {
        const list = document.getElementById('favList'); list.innerHTML = "";
        myFavs.forEach((t, i) => {
            const d = document.createElement('div'); d.className = "card";
            d.innerHTML = `<p>${t}</p><button onclick="myFavs.splice(${i},1); localStorage.setItem('my_favs',JSON.stringify(myFavs)); renderFavorites();" style="color:red">Ø­Ø°Ù</button>`;
            list.appendChild(d);
        });
    }

    function loadNames() {
        db.ref('names').on('value', s => {
            const grid = document.getElementById('namesGrid'); grid.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).forEach(n => {
                const b = document.createElement('div'); b.className = "main-btn-3d";
                b.innerHTML = `<span style="flex:1" onclick="alert(\`${data[n]}\`)">${n}</span>`;
                if(tg.initDataUnsafe.user?.id === ADMIN_ID) b.innerHTML += `<span onclick="deleteItem('names/${n}')">ğŸ—‘ï¸</span>`;
                grid.appendChild(b);
            });
        });
    }

    if(tg.initDataUnsafe.user?.id === ADMIN_ID) document.getElementById('adminPanel').style.display = 'block';
    tg.expand();
</script>
</body>
</html>
