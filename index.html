<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù„Ù‡ Ø£ÙˆÙ„Ø§Ù‹</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Reem+Kufi:wght@700&display=swap');
        :root { --gold: #b38728; --creamy: #fdfaf1; --brown: #4a342e; }
        body { font-family: 'Amiri', serif; background-color: var(--creamy); color: var(--brown); margin: 0; padding: 15px; direction: rtl; }
        .logo { font-family: 'Reem Kufi', sans-serif; font-size: 3em; text-align: center; color: var(--gold); margin: 20px 0; }
        .main-btn-3d { background: #fff; border: 2px solid var(--gold); padding: 15px; border-radius: 15px; margin-bottom: 10px; width: 100%; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-family: 'Amiri'; }
        .card { background: #fff; padding: 15px; border-radius: 15px; border-right: 5px solid var(--gold); margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .section { display: none; }
        .active { display: block; }
        .admin-input { width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        #subGuard { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--creamy); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    </style>
</head>
<body>

<div id="subGuard">
    <h2 style="color:var(--gold)">Ù†ÙˆØ±Ù†Ø§ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©.. âœ¨</h2>
    <p>Ù„Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹</p>
    <a href="https://t.me/fi9ha" target="_blank" style="text-decoration:none; color:#fff; background:var(--gold); padding:10px 30px; border-radius:10px;">Ø§Ù†Ø¶Ù…Ø§Ù…</a>
    <button onclick="verifySubscription()" style="margin-top:20px; border:none; background:none; cursor:pointer; color:var(--gold); font-weight:bold;">Ù„Ù‚Ø¯ Ø§Ø´ØªØ±ÙƒØªØŒ Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="container">
    <div id="home" class="section active">
        <h1 class="logo">Ø§Ù„Ù„Ù‡ Ø£ÙˆÙ„Ø§Ù‹</h1>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="main-btn-3d" onclick="showSection('namesList')">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø³Ù†Ù‰</button>
            <button class="main-btn-3d" onclick="showSection('thoughtsSection')">Ø®ÙˆØ§Ø·Ø±</button>
            <button class="main-btn-3d" onclick="showSection('moodPage')">Ø­Ø§Ù„ Ù‚Ù„Ø¨Ùƒ</button>
            <button class="main-btn-3d" onclick="showSection('favoritesPage')">Ø®Ø²Ø§Ù†ØªÙŠ â¤ï¸</button>
        </div>

        <div id="adminPanel" style="display:none; margin-top:30px; padding:15px; border:2px dashed var(--gold); border-radius:15px;">
            <h3 style="margin-top:0">ğŸ›  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
            <select id="adminActionType" class="admin-input">
                <option value="thoughts">Ø®Ø§Ø·Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>
                <option value="moods">Ø­Ø§Ù„Ø© Ù‚Ù„Ø¨ Ø¬Ø¯ÙŠØ¯Ø©</option>
                <option value="names">Ø§Ø³Ù… Ø§Ù„Ù„Ù‡ Ø¬Ø¯ÙŠØ¯</option>
            </select>
            <input type="text" id="targetName" class="admin-input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ù„Ù„Ø­Ø§Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡)">
            <textarea id="mainContent" class="admin-input" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..."></textarea>
            <button class="main-btn-3d" style="background:var(--gold); color:#fff; justify-content:center;" onclick="saveData()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
        </div>
    </div>

    <div id="namesList" class="section">
        <h2 class="logo" style="font-size:2em">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø³Ù†Ù‰</h2>
        <div id="namesGrid"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="thoughtsSection" class="section">
        <h2 class="logo" style="font-size:2em">Ø®ÙˆØ§Ø·Ø±</h2>
        <div id="thoughtsList"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="moodPage" class="section">
        <h2 class="logo" style="font-size:2em">ÙƒÙŠÙ Ø­Ø§Ù„ Ù‚Ù„Ø¨ÙƒØŸ</h2>
        <div id="moodGrid"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="favoritesPage" class="section">
        <h2 class="logo" style="font-size:2em">Ø®Ø²Ø§Ù†ØªÙŠ</h2>
        <div id="favList"></div>
        <button class="main-btn-3d" style="justify-content:center" onclick="showSection('home')">Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const ADMIN_ID = 8421694319;
    const BOT_TOKEN = '8000457608:AAEmrrhrKUf1-qRM-JDR1Ux8db3ia_v3zKw';
    const CHANNEL_ID = '@fi9ha';
    
    firebase.initializeApp({ databaseURL: "https://allahfirst-b9c52-default-rtdb.firebaseio.com/" });
    const db = firebase.database();

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'thoughtsSection') loadThoughts();
        if(id === 'moodPage') loadMoods();
        if(id === 'namesList') loadNames();
        if(id === 'favoritesPage') renderFavs();
        window.scrollTo(0,0);
    }

    async function verifySubscription() {
        const uId = tg.initDataUnsafe.user?.id;
        if (uId === ADMIN_ID) return;
        try {
            const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getChatMember?chat_id=${CHANNEL_ID}&user_id=${uId}`);
            const d = await res.json();
            if (d.ok && ['member','administrator','creator'].includes(d.result.status)) {
                document.getElementById('subGuard').style.display = 'none';
            } else {
                document.getElementById('subGuard').style.display = 'flex';
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
            }
        } catch(e) { document.getElementById('subGuard').style.display = 'none'; }
    }
    verifySubscription();

    function saveData() {
        const type = document.getElementById('adminActionType').value;
        const head = document.getElementById('targetName').value.trim();
        const body = document.getElementById('mainContent').value.trim();
        if(!body) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ!");

        if(type === 'thoughts') {
            db.ref('thoughts').push(body).then(() => alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“"));
        } else {
            if(!head) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†!");
            db.ref(type + '/' + head).set(body).then(() => alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“"));
        }
        document.getElementById('mainContent').value = "";
    }

    function del(path) {
        if(confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) db.ref(path).remove().then(() => alert("ØªÙ… Ø§Ù„Ø­Ø°Ù"));
    }

    function loadThoughts() {
        db.ref('thoughts').on('value', s => {
            const container = document.getElementById('thoughtsList');
            container.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).reverse().forEach(k => {
                const text = data[k];
                const card = document.createElement('div');
                card.className = "card";
                card.innerHTML = `<p>${text}</p>`;
                
                const btnFav = document.createElement('button');
                btnFav.innerText = "â¤ï¸ Ø­ÙØ¸ ÙÙŠ Ø®Ø²Ø§Ù†ØªÙŠ";
                btnFav.style = "border:none; background:none; color:red; cursor:pointer;";
                btnFav.onclick = () => saveToLocal(text);
                card.appendChild(btnFav);

                if(tg.initDataUnsafe.user?.id === ADMIN_ID) {
                    const btnDel = document.createElement('button');
                    btnDel.innerText = " ğŸ—‘ï¸ Ø­Ø°Ù";
                    btnDel.onclick = () => del('thoughts/'+k);
                    card.appendChild(btnDel);
                }
                container.appendChild(card);
            });
        });
    }

    function loadMoods() {
        db.ref('moods').on('value', s => {
            const container = document.getElementById('moodGrid');
            container.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).forEach(m => {
                const btn = document.createElement('div');
                btn.className = "main-btn-3d";
                const span = document.createElement('span');
                span.innerText = m;
                span.style.flex = "1";
                span.onclick = () => alert(data[m]);
                btn.appendChild(span);

                if(tg.initDataUnsafe.user?.id === ADMIN_ID) {
                    const dBtn = document.createElement('span');
                    dBtn.innerText = " ğŸ—‘ï¸";
                    dBtn.onclick = () => del('moods/'+m);
                    btn.appendChild(dBtn);
                }
                container.appendChild(btn);
            });
        });
    }

    function loadNames() {
        db.ref('names').on('value', s => {
            const container = document.getElementById('namesGrid');
            container.innerHTML = "";
            const data = s.val() || {};
            Object.keys(data).forEach(n => {
                const b = document.createElement('div');
                b.className = "main-btn-3d";
                const s1 = document.createElement('span');
                s1.innerText = n; s1.style.flex="1";
                s1.onclick = () => alert(data[n]);
                b.appendChild(s1);
                if(tg.initDataUnsafe.user?.id === ADMIN_ID) {
                    const s2 = document.createElement('span');
                    s2.innerText = " ğŸ—‘ï¸"; s2.onclick = () => del('names/'+n);
                    b.appendChild(s2);
                }
                container.appendChild(b);
            });
        });
    }

    // Ø§Ù„Ø®Ø²Ø§Ù†Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    function saveToLocal(txt) {
        let favs = JSON.parse(localStorage.getItem('myFavs') || '[]');
        if(!favs.includes(txt)) {
            favs.push(txt);
            localStorage.setItem('myFavs', JSON.stringify(favs));
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ â¤ï¸");
        }
    }
    function renderFavs() {
        const container = document.getElementById('favList');
        container.innerHTML = "";
        const favs = JSON.parse(localStorage.getItem('myFavs') || '[]');
        favs.forEach((t, i) => {
            const d = document.createElement('div');
            d.className = "card";
            d.innerHTML = `<p>${t}</p><button onclick="removeItem(${i})" style="color:red">Ø­Ø°Ù</button>`;
            container.appendChild(d);
        });
    }
    window.removeItem = (i) => {
        let favs = JSON.parse(localStorage.getItem('myFavs') || '[]');
        favs.splice(i, 1);
        localStorage.setItem('myFavs', JSON.stringify(favs));
        renderFavs();
    };

    if(tg.initDataUnsafe.user?.id === ADMIN_ID) document.getElementById('adminPanel').style.display = 'block';
    tg.expand();
</script>
</body>
</html>
