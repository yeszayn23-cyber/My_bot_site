import telebot
from telebot import types

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ---
API_TOKEN = '8000457608:AAEmrrhrKUf1-qRM-JDR1Ux8db3ia_v3zKw'
ADMIN_ID = 8421694319 
CHANNEL_ID = '@fi9ha'
bot = telebot.TeleBot(API_TOKEN)

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
config = {
    "site_url": "https://www.google.com", # ØºÙŠØ±Ù‡ Ø¨Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹Ùƒ Ù„Ø§Ø­Ù‚Ø§Ù‹
    "welcome_msg": "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø¨Ù†Ø¬Ø§Ø­. âœ…",
    "sub_required_msg": "ÙŠØ§ Ø®ÙˆÙŠØ§ Ø§Ù„Ø¹Ø²ÙŠØ²ØŒ Ù„Ø§Ø²Ù… ØªØ´ØªØ±Ùƒ ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙˆØª Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ø´ ØªÙ‚Ø¯Ø± ØªØ¯Ø®Ù„ Ù„Ù„Ù…ÙˆÙ‚Ø¹! ğŸ‘‡"
}

# --- Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ---
def is_subscribed(user_id):
    try:
        status = bot.get_chat_member(CHANNEL_ID, user_id).status
        if status in ['member', 'administrator', 'creator']:
            return True
        return False
    except Exception as e:
        print(f"Error checking sub: {e}")
        return False

# --- Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /start ---
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    
    # 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£ÙˆÙ„Ø§Ù‹
    if is_subscribed(user_id):
        # Ø¥Ø°Ø§ Ù…Ø´ØªØ±Ùƒ: Ù†Ø¨Ø¹Ø«ÙˆÙ„Ùˆ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ²Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹
        markup = types.InlineKeyboardMarkup()
        web_btn = types.InlineKeyboardButton("Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù† ğŸŒ", url=config["site_url"])
        markup.add(web_btn)
        
        bot.send_message(user_id, f"{config['welcome_msg']}\n\nØªÙØ¶Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ø¯Ù†Ø§Ù‡:", reply_markup=markup)
    else:
        # Ø¥Ø°Ø§ Ù…Ø´ Ù…Ø´ØªØ±Ùƒ: Ù†Ø·Ù„Ø¹ÙˆÙ„Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø© ÙˆØ²Ø± Ø§Ù„ØªØ­Ù‚Ù‚
        markup = types.InlineKeyboardMarkup()
        join_btn = types.InlineKeyboardButton("Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ù…Ù† Ù‡Ù†Ø§ ğŸ“¢", url=f"https://t.me/{CHANNEL_ID[1:]}")
        verify_btn = types.InlineKeyboardButton("ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ Ø¯Ø®ÙˆÙ„ âœ…", callback_data="check_sub")
        markup.add(join_btn)
        markup.add(verify_btn)
        
        bot.send_message(user_id, config["sub_required_msg"], reply_markup=markup)

# --- Ù…Ø¹Ø§Ù„Ø¬ Ø²Ø± "ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" ---
@bot.callback_query_handler(func=lambda call: call.data == "check_sub")
def verify_callback(call):
    if is_subscribed(call.from_user.id):
        bot.answer_callback_query(call.id, "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚! ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„. ğŸ‰")
        # Ù†Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆÙ†Ø¨Ø¹Ø« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
        bot.delete_message(call.message.chat.id, call.message.message_id)
        start(call.message) 
    else:
        bot.answer_callback_query(call.id, "Ù„Ù… ØªØ´ØªØ±Ùƒ Ø¨Ø¹Ø¯! âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹.", show_alert=True)

# --- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† (Ø£Ù†Øª ÙÙ‚Ø·) ---
@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if message.from_user.id == ADMIN_ID:
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("ØªØ¹Ø¯ÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ ğŸ”—", callback_data="edit_url"))
        
        msg = f"ğŸ›  **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†**\n\nØ§Ù„Ù‚Ù†Ø§Ø©: {CHANNEL_ID}\nØ§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: {config['site_url']}"
        bot.send_message(ADMIN_ID, msg, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "edit_url")
def edit_url_step(call):
    msg = bot.send_message(ADMIN_ID, "Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: https://example.com):")
    bot.register_next_step_handler(msg, save_new_url)

def save_new_url(message):
    config["site_url"] = message.text
    bot.send_message(ADMIN_ID, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
print("Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„ Ø§Ù„Ø¢Ù†...")
bot.polling(none_stop=True)
